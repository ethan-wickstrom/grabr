# Releasing `aigrab`

This repo uses a low‑effort, high‑automation, Bun‑first release system.

## Philosophy

- **Trunk‑based development:** `main` is always releasable.
- **Conventional Commits drive versions:** the commit history determines the next semver bump.
- **Release trains by default:** ship a batch weekly; ship immediately for urgent fixes.
- **No manual version bumps or tags:** automation handles versioning, changelog, tags, and npm publish.

## Required setup

Add these repository secrets:

1. `NPM_TOKEN`
   - npm publish token with access to the `aigrab` package.
   - Used by `.github/workflows/release.yml`.

2. `RELEASE_PLEASE_TOKEN`
   - Fine‑grained PAT (or GitHub App token) with:
     - **Contents: Read & Write**
     - **Pull requests: Read & Write**
   - Needed because PRs/tags created by the default `GITHUB_TOKEN` **do not trigger other workflows**.
   - Used by `.github/workflows/release-please.yml`.

## Release cadence

- **Weekly release train:** every **Wednesday at 17:00 UTC**.
  - Implemented by `.github/workflows/release-train.yml`.
  - If a Release PR is open and CI is green, it is auto‑merged and released.
- **Hotfixes:** merge the Release PR manually at any time (or dispatch the Release Train workflow).

## Developer workflow

1. **Write Conventional Commits**

   Examples:

   - `fix: handle null selection`
   - `feat: add React context extraction`
   - `chore: update docs`

   Semver mapping:
   - `fix:` → patch
   - `feat:` → minor
   - `feat!:` or `BREAKING CHANGE:` footer → major

2. **Merge PRs to `main`**

   CI (`.github/workflows/ci.yml`) runs tests/build/pack using Bun.

3. **Release Please opens/updates a Release PR**

   - `.github/workflows/release-please.yml` runs on each push to `main` (and weekday schedule).
   - It creates or updates a PR titled like `chore: release x.y.z`.
   - The PR bumps `package.json` and updates/creates `CHANGELOG.md`.

4. **Release Train merges the Release PR (weekly)**

   - `.github/workflows/release-train.yml` looks for open PRs labeled `autorelease: pending`.
   - It enables auto‑merge; once CI is green, GitHub merges it.

5. **Tag + GitHub Release created automatically**

   - When the Release PR merges, Release Please:
     - tags `vX.Y.Z`
     - creates a GitHub Release with autogenerated notes

6. **npm publish happens on tag push**

   - `.github/workflows/release.yml` runs on `v*` tags.
   - It re‑runs tests/build, validates tarball contents, and publishes via `bun publish`.

## Manual controls

- **Ship now:** merge the current Release PR, or run:
  - GitHub → Actions → **Release Train** → **Run workflow**
- **Re‑publish a tag (rare):**
  - GitHub → Actions → **Release** → **Run workflow**
  - Only use if npm publish failed after tag creation.

## Notes

- The `prepack` script (`bun test && bun run build`) ensures local publish sanity.
- If CI fails, fix forward with another PR; the Release PR will update automatically.

