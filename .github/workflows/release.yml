name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"

      - name: Validate tag matches package.json version
        if: startsWith(github.ref, 'refs/tags/')
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          bun -e '
            const tag = process.env.TAG_NAME ?? "";
            if (!tag.startsWith("v")) {
              throw new Error(`Expected tag to start with "v", got: ${tag}`);
            }
            const tagVersion = tag.slice(1);
            const pkg = await Bun.file("package.json").json();
            const pkgVersion = pkg.version;
            if (typeof pkgVersion !== "string" || pkgVersion.length === 0) {
              throw new Error("package.json missing valid \"version\"");
            }
            if (tagVersion !== pkgVersion) {
              throw new Error(`Tag version (${tagVersion}) does not match package.json version (${pkgVersion})`);
            }
            console.log(`OK: tag ${tag} matches package.json version ${pkgVersion}`);
          '

      - name: Install dependencies (bun ci)
        run: bun ci

      - name: Verify (test + build + pack dry-run)
        run: bun run verify

      - name: Configure npm auth (token)
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "${NPM_TOKEN}" ]; then
            echo "Missing secrets.NPM_TOKEN (npm publish token)." >&2
            exit 1
          fi
          NPMRC_PATH="${RUNNER_TEMP}/.npmrc"
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > "${NPMRC_PATH}"
          echo "NPM_CONFIG_USERCONFIG=${NPMRC_PATH}" >> "${GITHUB_ENV}"
          # Bun respects NPM_CONFIG_TOKEN; also set Bun/Node tokens for compatibility.
          echo "NPM_CONFIG_TOKEN=${NPM_TOKEN}" >> "${GITHUB_ENV}"
          echo "BUN_AUTH_TOKEN=${NPM_TOKEN}" >> "${GITHUB_ENV}"
          echo "NODE_AUTH_TOKEN=${NPM_TOKEN}" >> "${GITHUB_ENV}"

      - name: Verify npm authentication
        run: bun pm whoami

      - name: Publish to npm
        run: |
          # Prefer Bun-native publishing. If Bun has a transient auth issue on CI,
          # fall back to npm CLI to keep releases unblocked.
          bun publish --access public --ignore-scripts --no-save || bunx npm publish --access public --ignore-scripts
